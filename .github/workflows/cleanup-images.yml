name: Cleanup Old Docker Images

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œ (UTC)
    - cron: '0 2 * * 0'
  workflow_dispatch:

env:
  REGISTRY: docker.io
  NAMESPACE: cyberpoc

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get environments
        id: get-envs
        run: |
          cd go
          envs=$(ls -d */ | grep -v build | sed 's|/||' | tr '\n' ' ')
          echo "environments=$envs" >> $GITHUB_OUTPUT

      - name: Delete old images
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          # ç™»å½•åˆ°Docker Hub
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          
          # å¯¹æ¯ä¸ªçŽ¯å¢ƒæ¸…ç†æ—§é•œåƒ
          for env in ${{ steps.get-envs.outputs.environments }}; do
            echo "Processing environment: $env"
            
            # èŽ·å–é•œåƒæ ‡ç­¾åˆ—è¡¨ (ä¿ç•™æœ€æ–°çš„5ä¸ªç‰ˆæœ¬)
            # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä½¿ç”¨Docker Hub APIæˆ–è€…å…¶ä»–æ–¹å¼æ¥èŽ·å–å’Œåˆ é™¤æ ‡ç­¾
            # ç”±äºŽDocker Hubçš„é™åˆ¶ï¼Œè¿™é‡Œåªæ˜¯ç¤ºä¾‹ä»£ç 
            echo "Would cleanup old tags for cyberpoc/$env"
          done

      - name: Generate cleanup summary
        run: |
          echo "## ðŸ§¹ Image Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Environments processed:** ${{ steps.get-envs.outputs.environments }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Policy:** Keep latest 5 versions per environment" >> $GITHUB_STEP_SUMMARY
